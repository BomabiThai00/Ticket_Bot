#!/usr/bin/env ruby

# --- START: Azure Heartbeat Fix ---
require 'webrick'
Thread.new do
  port = ENV['PORT'] || 80
  puts "❤️ Starting Heartbeat on port #{port}..."
  log = WEBrick::Log.new(File.open(File::NULL, 'w'))
  server = WEBrick::HTTPServer.new(Port: port, Logger: log, AccessLog: [])
  server.mount_proc '/' do |req, res|
    res.body = 'TicketBot is alive!'
    res.status = 200
  end
  server.start
rescue StandardError => e
  puts "⚠️ Heartbeat failed: #{e.message}"
end
# --- END: Azure Heartbeat Fix ---

$stdout.sync = true
$stderr.sync = true

require 'dotenv/load'
require_relative '../lib/ticket_bot/core/configuration'
require_relative '../lib/ticket_bot/engine'

if ARGV.include?('--force_update')
  ENV['FORCE_UPDATE'] = 'true'
  ARGV.delete('--force_update') 
end

if ARGV[0] && !ARGV[0].start_with?('--')
  ENV['SINGLE_TICKET_NUMBER'] = ARGV[0]
end

if ENV['PLATFORM'] == 'hubspot'
  require_relative '../lib/ticket_bot/clients/hubspot_client'
  client = TicketBot::HubspotClient.new(ENV['HUBSPOT_TOKEN'])
else
  require_relative '../lib/ticket_bot/clients/zoho_client'
  require_relative '../lib/ticket_bot/authenticator'
  auth = TicketBot::Authenticator.new
  client = TicketBot::ZohoClient.new(TicketBot::Configuration.new, auth)
end

engine = TicketBot::Engine.new(TicketBot::Configuration.new, client)
engine.run